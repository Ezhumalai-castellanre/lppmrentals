# Signature Handling in Rental Application

This document explains how signatures are handled in the rental application form submission and PDF generation process.

## Overview

The signature system handles both image-based signatures (from signature pads) and text-based signatures, converting them appropriately for PDF generation and server submission.

## Signature Data Structure

Signatures are stored in the following format:

```typescript
interface SignatureData {
  applicant?: string;                    // Primary applicant signature
  coApplicants?: { [key: string]: string }; // Co-applicant signatures by index
  guarantors?: { [key: string]: string };   // Guarantor signatures by index
}
```

## Signature Types

### 1. Image Signatures (Base64)
- Generated by signature pad components
- Format: `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...`
- Automatically converted to images in PDF

### 2. Text Signatures
- Plain text input
- Displayed as-is in PDF

### 3. No Signature
- Shows `[NOT SIGNED]` in PDF
- Prevents form submission if required

## Implementation

### 1. Signature Pad Component

The `SignaturePad` component automatically generates base64 image data:

```tsx
<SignaturePad
  onSignatureChange={(signature) => handleSignatureChange('applicant', signature)}
  width={800}
  height={200}
/>
```

### 2. Signature State Management

Signatures are managed in the form state:

```typescript
const [signatures, setSignatures] = useState<any>({
  applicant: null,
  coApplicants: {},
  guarantors: {}
});
```

### 3. Signature Change Handler

```typescript
const handleSignatureChange = async (person: string, index?: string, signature?: string) => {
  let actualPerson = person;
  let actualSignature = signature || index;
  let actualIndex = signature ? index : undefined;

  if (actualIndex !== undefined) {
    // New format: person is the type (e.g., 'coApplicants'), index is the position
    setSignatures((prev: any) => ({
      ...prev,
      [actualPerson]: {
        ...prev[actualPerson],
        [actualIndex]: actualSignature,
      },
    }));
  } else {
    // Old format: person is the identifier (e.g., 'applicant')
    setSignatures((prev: any) => ({
      ...prev,
      [actualPerson]: actualSignature,
    }));
  }
};
```

## Form Submission

### 1. Signature Validation

Before submission, validate that all required signatures are present:

```typescript
import { validateSignatures, prepareSignaturesForSubmission } from '../lib/signature-utils';

// Validate signatures
const signatureValidation = validateSignatures(signatures);
if (!signatureValidation.isValid) {
  const errorMessage = signatureValidation.errors.join(', ');
  throw new Error(`Signature validation failed: ${errorMessage}`);
}

// Prepare signatures for submission
const submissionSignatures = prepareSignaturesForSubmission(signatures);
```

### 2. Include in Form Data

Signatures are included in the form submission data:

```typescript
const submissionData = {
  applicationData: {
    ...formData,
    signatures: submissionSignatures
  },
  userInfo: userInfo
};
```

## PDF Generation

### 1. Signature Processing

The PDF generator automatically processes signatures using utility functions:

```typescript
import { extractSignaturesForPDF, processSignatureData } from './signature-utils';

// Extract signatures from form data
const signatures = extractSignaturesForPDF(data);

// Process individual signatures
const processedSignature = processSignatureData(signatureData);
```

### 2. Image Rendering

Base64 image signatures are automatically converted to images in the PDF:

```typescript
if (processedSignature.type === 'image' && processedSignature.data) {
  // Extract image type and data
  const imgType = processedSignature.data.substring(
    processedSignature.data.indexOf('/') + 1, 
    processedSignature.data.indexOf(';')
  );
  const imgData = processedSignature.data.split(',')[1];
  
  // Add to PDF
  this.doc.addImage(imgData, imgType.toUpperCase(), x, y, width, height);
}
```

### 3. Fallback Handling

If image processing fails, the system falls back to text display:

```typescript
// If not an image or image adding failed, display text
this.doc.setFontSize(10);
this.doc.setFont("helvetica", "normal");
this.doc.setTextColor(51, 51, 51);
this.doc.text(processedSignature.displayText, x, y);
```

## Usage Examples

### 1. Adding Signatures to Form

```tsx
// Primary applicant
<SignaturePad
  onSignatureChange={(signature) => handleSignatureChange('applicant', signature)}
/>

// Co-applicant
<SignaturePad
  onSignatureChange={(signature) => handleSignatureChange('coApplicants', index.toString(), signature)}
/>

// Guarantor
<SignaturePad
  onSignatureChange={(signature) => handleSignatureChange('guarantors', index.toString(), signature)}
/>
```

### 2. Form Submission with Signatures

```typescript
const onSubmit = async (data: ApplicationFormData) => {
  try {
    // Validate signatures
    const signatureValidation = validateSignatures(signatures);
    if (!signatureValidation.isValid) {
      throw new Error(signatureValidation.errors.join(', '));
    }

    // Prepare submission data
    const submissionSignatures = prepareSignaturesForSubmission(signatures);
    const submissionData = {
      ...data,
      signatures: submissionSignatures
    };

    // Submit to server
    const response = await fetch('/api/submit-application', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(submissionData)
    });

    // Handle response...
  } catch (error) {
    console.error('Submission failed:', error);
  }
};
```

### 3. PDF Generation with Signatures

```typescript
import { RentalApplicationPDF } from '../lib/rental-application-pdf';

const generatePDF = (formData: any) => {
  const pdfGenerator = new RentalApplicationPDF();
  
  // Add form data including signatures
  const pdfData = {
    ...formData,
    signatures: formData.signatures
  };
  
  // Generate PDF
  const pdf = pdfGenerator.generate(pdfData);
  
  // Save or download
  pdf.save('rental-application.pdf');
};
```

## Error Handling

### 1. Signature Validation Errors

```typescript
const validation = validateSignatures(signatures);
if (!validation.isValid) {
  validation.errors.forEach(error => {
    toast({
      title: "Signature Required",
      description: error,
      variant: "destructive"
    });
  });
  return;
}
```

### 2. Image Processing Errors

```typescript
try {
  // Process signature image
  this.doc.addImage(imgData, imgType.toUpperCase(), x, y, width, height);
} catch (error) {
  console.error("Error adding signature image:", error);
  // Fallback to text display
  this.doc.text('[SIGNATURE IMAGE]', x, y);
}
```

## Best Practices

1. **Always validate signatures** before form submission
2. **Handle image processing errors** gracefully with fallbacks
3. **Use consistent signature keys** across the application
4. **Test signature handling** with various input types
5. **Log signature processing** for debugging purposes

## Troubleshooting

### Common Issues

1. **Signatures not appearing in PDF**
   - Check if signature data is properly passed to PDF generator
   - Verify signature format (base64 vs text)
   - Check console for image processing errors

2. **Form submission fails**
   - Validate all required signatures are present
   - Check signature data structure
   - Verify signature validation logic

3. **Image signatures not rendering**
   - Ensure base64 data is properly formatted
   - Check image type support (PNG, JPEG, etc.)
   - Verify jsPDF image handling

### Debug Information

Enable detailed logging for signature processing:

```typescript
console.log('Raw signatures:', signatures);
console.log('Processed signatures:', extractSignaturesForPDF(formData));
console.log('Signature validation:', validateSignatures(signatures));
```
